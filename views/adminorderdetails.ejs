<%-include('adminheader')%>
    </aside>
    <main class="main-wrap">
        <header class="main-header navbar">
            <div class="col-search">
                <form class="searchform">
                    <div class="input-group">
                        <input list="search_terms" type="text" class="form-control" placeholder="Search term">
                        <button class="btn btn-light bg" type="button"> <i class="material-icons md-search"></i></button>
                    </div>
                    <datalist id="search_terms">
                        <option value="Products">
                        <option value="New orders">
                        <option value="Apple iphone">
                        <option value="Ahmed Hassan">
                    </datalist>
                </form>
            </div>
            <div class="col-nav">
                <button class="btn btn-icon btn-mobile me-auto" data-trigger="#offcanvas_aside"> <i class="material-icons md-apps"></i> </button>
                <ul class="nav">
                    <li class="nav-item">
                        <a class="nav-link btn-icon" href="#">
                            <i class="material-icons md-notifications animation-shake"></i>
                            <span class="badge rounded-pill">3</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link btn-icon darkmode" href="#"> <i class="material-icons md-nights_stay"></i> </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="requestfullscreen nav-link btn-icon"><i class="material-icons md-cast"></i></a>
                    </li>
                    <li class="dropdown nav-item">
                        <a class="dropdown-toggle" data-bs-toggle="dropdown" href="#" id="dropdownLanguage" aria-expanded="false"><i class="material-icons md-public"></i></a>
                        <div class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownLanguage">
                            <a class="dropdown-item text-brand" href="#"><img src="adminassets/imgs/theme/flag-us.png" alt="English">English</a>
                            <a class="dropdown-item" href="#"><img src="adminassets/imgs/theme/flag-fr.png" alt="Français">Français</a>
                            <a class="dropdown-item" href="#"><img src="adminassets/imgs/theme/flag-jp.png" alt="Français">日本語</a>
                            <a class="dropdown-item" href="#"><img src="adminassets/imgs/theme/flag-cn.png" alt="Français">中国人</a>
                        </div>
                    </li>
                    <li class="dropdown nav-item">
                        <a class="dropdown-toggle" data-bs-toggle="dropdown" href="#" id="dropdownAccount" aria-expanded="false"> <img class="img-xs rounded-circle" src="assets/imgs/people/avatar2.jpg" alt="User"></a>
                        <div class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownAccount">
                            <a class="dropdown-item" href="#"><i class="material-icons md-perm_identity"></i>Edit Profile</a>
                            <a class="dropdown-item" href="#"><i class="material-icons md-settings"></i>Account Settings</a>
                            <a class="dropdown-item" href="#"><i class="material-icons md-account_balance_wallet"></i>Wallet</a>
                            <a class="dropdown-item" href="#"><i class="material-icons md-receipt"></i>Billing</a>
                            <a class="dropdown-item" href="#"><i class="material-icons md-help_outline"></i>Help center</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item text-danger" href="#"><i class="material-icons md-exit_to_app"></i>Logout</a>
                        </div>
                    </li>
                </ul>
            </div>
        </header>
        <section class="content-main">
            <div class="content-header">
                <div>
                    <h2 class="content-title card-title">Order Details</h2>
                  
                </div>
                <div>
                    <input type="text" placeholder="Search order ID" class="form-control bg-white">
                </div>
            </div>
            <div class="card mb-4">
                <header class="card-header">
                    <!-- <div class="row gx-3">
                        <div class="col-lg-4 col-md-6 me-auto">
                            <input type="text" placeholder="Search..." class="form-control">
                        </div>
                        <div class="col-lg-2 col-6 col-md-3">
                            <select class="form-select">
                                <option>Status</option>
                                <option>Active</option>
                                <option>Disabled</option>
                                <option>Show all</option>
                            </select>
                        </div>
                        <div class="col-lg-2 col-6 col-md-3">
                            <select class="form-select">
                                <option>Show 20</option>
                                <option>Show 30</option>
                                <option>Show 40</option>
                            </select>
                        </div>
                    </div> -->
                </header> <!-- card-header end// -->
               <!-- Content wrapper scroll start -->
    <div class="container content-wrapper-scroll">
        <div class="content-wrapper">
            <div class="row gutters bg-white">
                <!-- Product Table Section -->
                <div class="col-lg-12">
                    <div class="card-body">
                        <div class="row mt-20 order-info-wrap">
                            <div class="col-lg-10">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th width="40%">Product</th>
                                                <th width="20%">Unit Price</th>
                                                <th width="20%">Quantity</th>
                                                <th width="20%" class="text-end">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Loop through products in the order -->
                                            <% orders.items.forEach((item) => { %>
                                            <tr>
                                                <td>
                                                    <a class="itemside" href="#">
                                                        <div class="left">
                                                            <img src="userImages/<%= item.image %>" width="40" height="40"
                                                                class="img-xs" alt="<%= item.name %>">
                                                        </div>
                                                        <div class="info"> <%= item.name %> </div>
                                                    </a>
                                                </td>
                                                <td> &#8377;<%= item.productPrice %></td>
                                                <td> <%= item.quantity %></td>
                                                <td class="text-end"> &#8377;<%= item.price %></td>
                                            </tr>

                                            <% }); %>
                                            <tr>
                                                <td colspan="4">
                                                    <article class="float-end">
                                                        <dl class="dlist">
                                                            <dt>Subtotal:</dt>
                                                            <dd>&#8377;<%= orders.billTotal %></dd>
                                                        </dl>
                                                        <dl class="dlist">
                                                            <dt>Grand total:</dt>
                                                            <dd> <b class="h5">&#8377;<%= orders.billTotal %></b> </dd>
                                                        </dl>
                                                        <dl class="dlist">
                                                            <dt class="text-muted">Payment Status:</dt>
                                                            <dd>
                                                                <span
                                                                    class="badge rounded-pill alert-success text-success"><%= orders.paymentStatus %></span>
                                                            </dd>
                                                        </dl>
                                                    </article>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Three Sections Below Product Table -->
                <div class="col-lg-4 col-md-12 col-sm-12 ">
                    <!-- General Details Section -->
                    <div class="card ">
                        <div class="card-header" style="font-weight: bolder;">General Details</div>
                        <div class="card-body">
                          

                                <label for="orderId" style="font-weight: bolder;">Order Id:</label><br>
                                <%= orders.oId %><br /><br />
                                <label for="orderDate" style="font-weight: bolder;">Order Date:</label><br>
                                <input type="text" class="mt-2 mb-2 text-brand border-0"
                                    value="<%= orders.orderDate.toDateString() %>" disabled /><br>
                                    <form id="orderStatusForm"
                                    onsubmit="submitOrderStatusForm('<%= orders._id %>'); return false;">
                                <label for="orderStatus mt-4" style="font-weight: bolder;">Order Status:</label><br>
                                <select name="orderStatus" class="form-select mt-2" data-live-search="true">
                                    <% switch (orders.status) {
                                        case 'Pending': %>
                                    <option value="Pending" selected>Pending</option>
                                    <option value="Processing">Processing</option>
                                    <option value="Shipped">Shipped</option>
                                    <option value="Canceled">Canceled</option>
                                    <% break;
                                        case 'Processing': %>
                                    <option value="Pending">Pending</option>
                                    <option value="Processing" selected>Processing</option>
                                    <option value="Shipped">Shipped</option>
                                    <option value="Canceled">Canceled</option>
                                    <% break;
                                        case 'Shipped': %>
                                    <option value="Shipped" selected>Shipped</option>
                                    <option value="Canceled">Canceled</option>
                                    <option value="Delivered">Delivered</option>
                                    <% break;
                                       case 'Canceled': %>
                                    <option value="Canceled">Canceled</option>
                                    <% break;                                                  
                                        default: %>
                                    <option value="Delivered">Delivered</option>
                                    <% } %>
                                </select><br>
                                <button type="submit" class="btn btn-primary">Save Order</button>
                            </form>
                                    


                        </div>
                    </div>





                    <!-- User Details Section -->
                    <div class="card">
                        <div class="card-header" style="font-weight: bolder;">User Details</div>
                        <div class="card-body">
                            <strong style="font-weight: bold;"> Name:</strong>
                            <span class="text-brand"> <%= orders.user.username %></span><br>
                            <strong style="font-weight: bold;">Email:</strong>
                            <span class="text-brand"> <%= orders.user.email %></span><br>
                           
                            <strong style="font-weight: bold;">Blocked:</strong>
                            <span class="text-brand"><%= orders.user.isBlocked ? "Yes" : "No" %></span><br>
                            <strong style="font-weight: bold;">Mobile:</strong>
                            <span class="text-brand"> <%= orders.user.phone %></span>

                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="card-header" style="font-weight: bolder;">User Requests</div>
                            <% if (orders && orders.requests && orders.requests.length > 0) { %>
                                <% if (orders.requests[0].status === 'Accepted') { %>
                                    <p class="h6 text-center">No requests available.</p>
                                <% } else { %>
                                    <% if (orders.requests[0].status === 'Pending') { %>
                                        <h6>Request for: <%= orders.requests[0].type %></h6>
                                        <label for="reason">Reason:</label>
                                        <input type="text" value="<%= orders.requests[0].reason %>" readonly class="mb-3 text-center">
                                        <br><br>
                                        <p>Request status: <%= orders.requests[0].status %></p>
                                        <button class="btn btn-success" onclick="acceptCancel('<%= orders._id %>')">Accept</button>
                                        <button class="btn btn-danger" onclick="rejectCancel('<%= orders.oId %>')">Reject</button>
                                    <% } else if (orders.status === 'Delivered' && orders.requests[0].status === 'Pending') { %>
                                        <strong class="text-brand mb-3 mt-2 text-center">Order Returned <span style="font-size: 14px; color: black;">(Reason)</span></strong>
                                        <input type="text" value="<%= orders.requests[0].reason %>" readonly class="mb-3 text-center border-0">
                                        <button class="btn btn-success w-50 mb-3 text-center ms-5 refund" onclick="refundAmount('<%= orders._id %>','<%= orders.user._id %>')">Accept Return Order</button> 
                                    <% } else { %>
                                        <!-- Display other request details as needed -->
                                        <% orders.requests.forEach(request => { %>
                                            <% if (request.type === 'Return') { %>
                                                <div class="pt-3">Order return accepted</div>
                                                <span><a href="#" class="text-decoration-underline" target="_blank"></a> <i class="bi bi-box-arrow-up-right"></i></span>
                                            <% } %>
                                        <% }) %>
                                    <% } %>
                                <% } %>
                            <% } else { %>
                                <p class="h6 text-center">No requests available.</p>
                            <% } %>
                            

                        </div>
                        <hr>
                    </div>
                </div>

                <div class="col-lg-4 col-md-12 col-sm-12">
                    <div class="card">
                        <div class="card-header" style="font-weight: bolder;">Shipping Details</div>
                        <div class="card-body">
                            <label for="Address" style="font-weight: bolder;">Address Type: </label>
                            <span class="text-brand"
                                style="font-weight: bolder;"><%= orders.deliveryAddress.addressType.toUpperCase() %></span><br>

                            <label for="HouseNo" style="font-weight: bolder;">House Number:</label>
                            <span class="text-brand"
                                style="font-weight: bolder;"><%= orders.deliveryAddress.HouseNo %></span><br>

                            <label for="Street" style="font-weight: bolder;">Street:</label>
                            <span class="text-brand"
                                style="font-weight: bolder;"><%= orders.deliveryAddress.Street %></span><br>

                            <label for="Landmark" style="font-weight: bolder;">Landmark:</label>
                            <span class="text-brand"
                                style="font-weight: bolder;"><%= orders.deliveryAddress.Landmark %></span><br>

                            <label for="Pincode" style="font-weight: bolder;">Pincode:</label>
                            <span class="text-brand"
                                style="font-weight: bolder;"><%= orders.deliveryAddress.pincode %></span><br>

                            <label for="City" style="font-weight: bolder;">City:</label>
                            <span class="text-brand"
                                style="font-weight: bolder;"><%= orders.deliveryAddress.city %></span><br>

                            <label for="District" style="font-weight: bolder;">District:</label>
                            <span class="text-brand"
                                style="font-weight: bolder;"><%= orders.deliveryAddress.district %></span><br>

                            <label for="State" style="font-weight: bolder;">State:</label>
                            <span class="text-brand"
                                style="font-weight: bolder;"><%= orders.deliveryAddress.State %></span><br>

                            <label for="Country" style="font-weight: bolder;">Country:</label>
                            <span class="text-brand"
                                style="font-weight: bolder;"><%= orders.deliveryAddress.Country %></span><br>
                        </div>
                    </div>


                    <!--payment details section -->
                    <div class="card">
                        <div class="card-header" style="font-weight: bolder;">Payment Details</div>
                        <div class="card-body">
                            <label for="BillTotal" style="font-weight: bolder;">Bill Total:</label>
                            <span class="text-brand"> INR <%= orders.billTotal %></span><br>

                            <label for="PaymentMethod" style="font-weight: bolder;">Payment Method:</label>
                            <span class="text-brand"><%= orders.paymentMethod %></span><br>

                            <label for="PaymentStatus" style="font-weight: bolder;">Payment Status:</label>
                            <span class="text-brand"><%= orders.paymentStatus %></span><br>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div> <!-- card end// -->
           
        </section> <!-- content-main end// -->
        
    </main>
    <script src="adminassets/js/vendors/jquery-3.6.0.min.js"></script>
    <script src="adminassets/js/vendors/bootstrap.bundle.min.js"></script>
    <script src="admin/js/vendors/select2.min.js"></script>
    <script src="adminassets/js/vendors/perfect-scrollbar.js"></script>
    <script src="adminassets/js/vendors/jquery.fullscreen.min.js"></script>
    <!-- Main Script -->
    <script src="adminassets/js/main.js" type="text/javascript"></script>
    <script>
        function acceptCancel(id) {
            $.ajax({
                url: `acceptcancel/?id=${id}`,
                type: 'POST',
                success: function(data) {
                  alert(data.message);
                //   window.location.reload()
                },
                error: function(xhr, status, error) {
                    console.error('There was a problem removing the address:', error);
                    // Handle error appropriately, e.g., display an error message to the user
                }
            });
        }
        
        
            </script>
          <script>
            function submitOrderStatusForm(orderId) {
               
                var newStatus = $('[name="orderStatus"]').val();
        
                $.ajax({
                    type: 'POST',
                    url: '/admin/updateOrderStatus', // Replace this with your server route
                    data: { orderId: orderId, newStatus: newStatus },
                    success: function(response) {
                        console.log(response);
                       window.location.reload();
                    },
                    error: function(error) {
                        console.error(error);
                        // Handle error
                    }
                });
            }
        </script>
        
</body>

</html>